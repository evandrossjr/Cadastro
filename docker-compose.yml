services:
  # ------------------------------------
  # SERVIÇO DA APLICAÇÃO SPRING BOOT
  # ------------------------------------
  # 1. Renomeei o serviço para 'app' (mais simples)
  app:
    # 2. Usa a imagem PRIVADA correta do seu Docker Hub
    image: evandrossjr/cadastro_ca:latest
    # 3. Garante que o GitHub Actions sempre baixe a imagem nova
    pull_policy: always
    ports:
      - "8080:8080"
    environment:
      # 4. Aponta a aplicação para o serviço 'db' (Postgres)
      - SPRING_DATASOURCE_URL=jdbc:postgresql://db:5432/mydatabase
      - SPRING_DATASOURCE_USERNAME=myuser
      - SPRING_DATASOURCE_PASSWORD=1234567
      - SPRING_DATASOURCE_DRIVER_CLASS_NAME=org.postgresql.Driver
      - SPRING_JPA_DATABASE_PLATFORM=org.hibernate.dialect.PostgreSQLDialect
      # 5. DDL-auto 'validate' é mais seguro para testes de compose, mas usarei update desta vez para passar no teste já que o banco é h2
      - SPRING_JPA_HIBERNATE_DDL_AUTO=update
    # 6. Garante que o 'db' inicie ANTES do 'app'
    depends_on:
      db:
        condition: service_healthy # Espera o banco estar saudável

  # ------------------------------------
  # SERVIÇO DO BANCO DE DADOS POSTGRES
  # ------------------------------------
  db:
    image: postgres:14-alpine
    environment:
      - POSTGRES_DB=mydatabase
      - POSTGRES_USER=myuser
      - POSTGRES_PASSWORD=1234567
    healthcheck:
      # 7. Adiciona uma verificação de saúde (para o 'depends_on' funcionar)
      test: ["CMD-SHELL", "pg_isready -U myuser -d mydatabase"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - default

